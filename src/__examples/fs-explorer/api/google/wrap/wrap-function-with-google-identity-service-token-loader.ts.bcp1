import { AsyncTask, Abortable, IAsyncTaskConstraint } from '@lirx/async-task';
import { loadGoogleIdentityService, IGoogleIdentityService } from '../load-google-identity-service';
import { getGoogleIdentityServiceToken, IGetGoogleIdentityServiceToken } from '../get-google-identity-service-token';

export interface IWrapFunctionWithGoogleIdentityServiceTokenLoaderInputFunction<GOptions, GReturn extends IAsyncTaskConstraint<GReturn>> {
  (
    options: IWrapFunctionWithGoogleIdentityServiceTokenLoaderInputOptions<GOptions>,
  ): AsyncTask<GReturn>,
}

export type IWrapFunctionWithGoogleIdentityServiceTokenLoaderInputOptions<GOptions> = GOptions & IGetGoogleIdentityServiceToken & {
  readonly token: string;
};

export interface IWrapFunctionWithGoogleIdentityServiceTokenLoaderOutputFunction<GOptions, GReturn extends IAsyncTaskConstraint<GReturn>> {
  (
    options: IWrapFunctionWithGoogleIdentityServiceTokenLoaderOutputOptions<GOptions>,
  ): AsyncTask<GReturn>,
}

export type IWrapFunctionWithGoogleIdentityServiceTokenLoaderOutputOptions<GOptions> =
  GOptions
  & Omit<IGetGoogleIdentityServiceToken, 'gis'>;

export function wrapFunctionWithGoogleIdentityServiceTokenLoader<GOptions, GReturn extends IAsyncTaskConstraint<GReturn>>(
  fnc: IWrapFunctionWithGoogleIdentityServiceTokenLoaderInputFunction<GOptions, GReturn>,
): IWrapFunctionWithGoogleIdentityServiceTokenLoaderOutputFunction<GOptions, GReturn> {
  return (
    {
      abortable,
      ...options
    }: IWrapFunctionWithGoogleIdentityServiceTokenLoaderOutputOptions<GOptions>,
  ): AsyncTask<GReturn> => {
    return loadGoogleIdentityService(abortable)
      .successful((gis: IGoogleIdentityService, abortable: Abortable): any => {
        return getGoogleIdentityServiceToken({
          ...options,
          gis,
          abortable,
        })
          .successful((token: string): any => {
            return fnc({
              ...options,
              gis,
              token,
            } as IWrapFunctionWithGoogleIdentityServiceTokenLoaderInputOptions<GOptions>);
          });
      });
  };
}
